# Ephemeral test overlay â€” no persistent volumes.
#
# Stacks on top of docker-compose.yml. All data is destroyed on
# `docker compose down` so every run starts from a clean slate.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.test.yml up mysql openemr -d --wait
#   docker compose -f docker-compose.yml -f docker-compose.test.yml down

name: openemr-integration-test

services:
  mysql:
    restart: "no"
    volumes: !override
      - ../library/sql-ssl-certs-keys/easy/ca.pem:/etc/ssl/ca.pem:ro
      - ../library/sql-ssl-certs-keys/easy/server-cert.pem:/etc/ssl/server-cert.pem:ro
      - ../library/sql-ssl-certs-keys/easy/server-key.pem:/etc/ssl/server-key.pem:ro
    tmpfs:
      - /var/lib/mysql

  openemr:
    restart: "no"
    volumes: !override
      - ../..:/openemr:ro
      - ../..:/var/www/localhost/htdocs/openemr:rw
    tmpfs:
      - /var/www/localhost/htdocs/openemr/public/assets
      - /var/www/localhost/htdocs/openemr/public/themes
      - /var/www/localhost/htdocs/openemr/sites
      - /var/www/localhost/htdocs/openemr/node_modules
      - /var/www/localhost/htdocs/openemr/vendor
      - /var/www/localhost/htdocs/openemr/ccdaservice/node_modules
      - /couchdb/data
    environment:
      XDEBUG_ON: 0
      OPENEMR_SETTING_ccda_alt_service_enable: 0
      # Clear dev-only settings that aren't needed for integration tests
      OPENEMR_SETTING_couchdb_host: ""
      OPENEMR_SETTING_gbl_ldap_host: ""
